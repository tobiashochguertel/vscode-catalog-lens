#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}ğŸ” Running pre-commit checks...${NC}"
echo ""

# STEP 1: Auto-fix linting issues
echo "${BLUE}ğŸ“ Step 1/4: Linting and auto-fixing...${NC}"
pnpm lint:fix

# Check if auto-fix worked
if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}âŒ Lint auto-fix couldn't resolve all issues!${NC}"
  echo "${YELLOW}ğŸ’¡ Please fix the remaining errors manually.${NC}"
  echo "${YELLOW}ğŸ’¡ Run 'pnpm lint' to see all errors.${NC}"
  exit 1
fi

# Re-add auto-fixed files to staging
echo "${GREEN}âœ“ Auto-fix completed${NC}"
echo "${BLUE}ğŸ“¦ Re-staging auto-fixed files...${NC}"
git add -u

# STEP 2: Verify no lint errors remain
echo ""
echo "${BLUE}ğŸ“‹ Step 2/4: Verifying lint status...${NC}"
pnpm lint

if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}âŒ Lint errors still exist after auto-fix!${NC}"
  echo "${YELLOW}ğŸ’¡ Some issues require manual fixes.${NC}"
  echo "${YELLOW}ğŸ’¡ Please review and fix the errors above.${NC}"
  exit 1
fi

echo "${GREEN}âœ“ No lint errors${NC}"

# STEP 3: Type checking
echo ""
echo "${BLUE}ğŸ”§ Step 3/4: Type checking...${NC}"
pnpm typecheck

if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}âŒ Type check failed!${NC}"
  echo "${YELLOW}ğŸ’¡ Fix type errors before committing.${NC}"
  exit 1
fi

echo "${GREEN}âœ“ Type check passed${NC}"

# STEP 4: Build
echo ""
echo "${BLUE}ğŸ—ï¸  Step 4/4: Building...${NC}"
pnpm build > /dev/null 2>&1

if [ $? -ne 0 ]; then
  echo ""
  echo "${RED}âŒ Build failed!${NC}"
  echo "${YELLOW}ğŸ’¡ Run 'pnpm build' to see build errors.${NC}"
  exit 1
fi

echo "${GREEN}âœ“ Build successful${NC}"

echo ""
echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""
