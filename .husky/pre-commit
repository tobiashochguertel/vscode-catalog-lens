#!/usr/bin/env bash

# Modern Husky v9 - no need to source husky.sh anymore

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}üîç Running pre-commit checks...${NC}"
echo

# STEP 1: Format code with Prettier
echo "${BLUE}‚ú® Step 1/7: Formatting code with Prettier...${NC}"
pnpm format > /dev/null 2>&1

if [ $? -ne 0 ]; then
  echo
  echo "${RED}‚ùå Prettier formatting failed!${NC}"
  echo "${YELLOW}üí° Run 'pnpm format' to see errors.${NC}"
  exit 1
fi

echo "${GREEN}‚úì Prettier formatting completed${NC}"
git add -u

# STEP 2: Lint and fix markdown
echo
echo "${BLUE}üìù Step 2/7: Linting markdown files...${NC}"
pnpm markdown:fix > /dev/null 2>&1

if [ $? -ne 0 ]; then
  echo
  echo "${YELLOW}‚ö†Ô∏è  Markdown linting found issues (attempting fix)${NC}"
  pnpm markdown:fix
fi

echo "${GREEN}‚úì Markdown linting completed${NC}"
git add -u

# STEP 3: Auto-fix linting issues
echo
echo "${BLUE}‚ú® Step 3/7: Linting and auto-fixing...${NC}"
pnpm lint:fix

# Check if auto-fix worked
if [ $? -ne 0 ]; then
  echo
  echo "${RED}‚ùå Lint auto-fix couldn't resolve all issues!${NC}"
  echo "${YELLOW}üí° Please fix the remaining errors manually.${NC}"
  echo "${YELLOW}üí° Run 'pnpm lint' to see all errors.${NC}"
  exit 1
fi

# Re-add auto-fixed files to staging
echo "${GREEN}‚úì Auto-fix completed${NC}"
echo "${BLUE}üì¶ Re-staging auto-fixed files...${NC}"
git add -u

# STEP 4: Verify no lint errors remain
echo
echo "${BLUE}üìã Step 4/7: Verifying lint status...${NC}"
pnpm lint

if [ $? -ne 0 ]; then
  echo
  echo "${RED}‚ùå Lint errors still exist after auto-fix!${NC}"
  echo "${YELLOW}üí° Some issues require manual fixes.${NC}"
  echo "${YELLOW}üí° Please review and fix the errors above.${NC}"
  exit 1
fi

echo "${GREEN}‚úì No lint errors${NC}"

# STEP 5: Type checking
echo
echo "${BLUE}‚ú® Step 5/7: Type checking...${NC}"
pnpm typecheck

if [ $? -ne 0 ]; then
  echo
  echo "${RED}‚ùå Type check failed!${NC}"
  echo "${YELLOW}üí° Fix type errors before committing.${NC}"
  exit 1
fi

echo "${GREEN}‚úì Type check passed${NC}"

# STEP 6: Build
echo
echo "${BLUE}üèóÔ∏è Step 6/7: Building...${NC}"
pnpm build > /dev/null 2>&1

if [ $? -ne 0 ]; then
  echo
  echo "${RED}‚ùå Build failed!${NC}"
  echo "${YELLOW}üí° Run 'pnpm build' to see build errors.${NC}"
  exit 1
fi

echo "${GREEN}‚úì Build successful${NC}"

# STEP 7: Validate GitHub Actions workflows (if actionlint is available)
echo
echo "${BLUE}‚öôÔ∏è Step 7/7: Validating GitHub Actions workflows...${NC}"

if command -v actionlint > /dev/null 2>&1; then
  if ./scripts/lint-workflows.sh > /dev/null 2>&1; then
    echo "${GREEN}‚úì Workflow validation passed${NC}"
  else
    echo
    echo "${YELLOW}‚ö†Ô∏è  Workflow validation found issues (non-blocking):${NC}"
    ./scripts/lint-workflows.sh || true  # Prevent exit code from failing the hook
    echo
    echo "${YELLOW}üí° Fix workflow errors when convenient.${NC}"
    echo "${YELLOW}üí° Run 'pnpm workflow:lint' to see details.${NC}"
  fi
else
  echo "${YELLOW}‚ö†Ô∏è  actionlint not installed (skipping)${NC}"
  echo "${YELLOW}üí° Install with: brew install actionlint${NC}"
fi

echo
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
echo
